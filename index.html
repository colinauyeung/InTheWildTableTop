<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        #viewbox {
            width: 850px;
            height: 400px;
            background-color: orange;
            overflow: scroll;
        }

        .thumb {
            width: 190px;
            height: 200px;
            padding: 5px;
            float: left;
            overflow: hidden;
        }

        .thumbimg{
            max-width: 190px;
            pointer-events: none;
        }

        .button{

            /*float: left;*/
        }

        .title{
            font-size: 24px;
            padding: 5px;
        }


    </style>
</head>
<body>
<div id="mess" class="title">
    Press ~ to Start a Recording!
</div>
<label for="rewind">Video Playback Controls</label>
<button id="rewind" class="button" disabled><<</button>
<button id="back" class="button" disabled><</button>
<button id="play" class="button" disabled>Pause</button>
<button id="forward" class="button" disabled>></button>
<button id="fastforward" class="button" disabled>>></button>
<label for="anno">Name your clips: </label>
<input type="text" id="anno" name="anno"
       size="12" placeholder="Name your clip!">

<div id="bounding">

    <div id="box2">
        <video id="video" autoplay style="display:none;"></video>
        <canvas id="canvas" style="width:640px; height:480px;"></canvas>
    </div>





</div>
<div class="title">
    View Past Recordings
</div>
<label for="selection">Choose a date (day/month) to view:</label>

<select name="cars" id="selection">
<!--    <option value="volvo">Volvo</option>-->
<!--    <option value="saab">Saab</option>-->
<!--    <option value="mercedes">Mercedes</option>-->
<!--    <option value="audi">Audi</option>-->
</select>

<button id="btn">View</button>

<div id="viewbox">
</div>
<canvas id="canvashidden" style="width:1920px; height:1080px; opacity: 0; position: absolute; left: -1920px; top: -1080px;"></canvas>


<script>
    var electron = require('electron');
    const ffmpegPath = require('@ffmpeg-installer/ffmpeg').path;
    const ffmpeg = require('fluent-ffmpeg');
    ffmpeg.setFfmpegPath(ffmpegPath);
    var FileSaver = require('file-saver');
    const remote = require('electron').remote;
    const windowManager = remote.require('electron-window-manager');
    var fs = require('fs');
    const { v4: uuidv4 } = require('uuid');

    var videodir = "./videos/";
    var thumbdir = "./thumbnails/"

    const btn = document.getElementById("btn");
    const select = document.getElementById("selection");
    const rewind = document.getElementById("rewind");
    const backbtn = document.getElementById("back");
    const playbtn = document.getElementById("play");
    const forwardbtn = document.getElementById("forward");
    const fastforward = document.getElementById("fastforward");

    var filename;
    var vidstream;
    var canvas, context;
    var canvash, contexth;
    var looprecording = false;
    var recordingtime = 10000;
    var recorder;
    var camera;
    var blobs = [];
    var videos = {
        files: [],
        dates: []
    };
    var first = true;
    var firstplay = false;
    var playing = true;
    var recording = false;
    var processing = false;

    window.addEventListener('DOMContentLoaded', () => {
        canvas = document.getElementById("canvas");
        context = canvas.getContext("2d");
        canvash = document.getElementById("canvashidden");
        contexth = canvash.getContext("2d");
        let rawdata = fs.readFileSync('videos.json');
        videos = JSON.parse(rawdata);
        windowManager.sharedData.set("videos", videos);
        for(let i in videos.dates){
            createoption(videos.dates[i]);
        }
        // for(let i in videos.files){
        //     thumb(videos.files[i]);
        // }
        // startRecording();
    });

    btn.onclick = (event) => {
        event.preventDefault();
        let filter = select.value;
        let viewbox = document.getElementById("viewbox");
        viewbox.innerHTML = "";
        for(let i in videos.files){
            if(videos.files[i].date === filter){
                thumb(videos.files[i]);
            }

        }
    }

    playbtn.onclick = (e) =>{
        if(playing){
            playbtn.innerText = "Play";
        }
        else{
            playbtn.innerText = "Pause";
        }
        windowManager.sharedData.set("playbtn", true);
        playing = !playing;
    }

    fastforward.onclick = (e) => {
        windowManager.sharedData.set("fastforward", true);
    }

    rewind.onclick = (e) => {
        windowManager.sharedData.set("rewind", true);
    }

    forwardbtn.onclick = (e) => {
        windowManager.sharedData.set("forward", true);
    }

    backbtn.onclick = (e) => {
        windowManager.sharedData.set("back", true);
    }




    function createoption(date){
        let select = document.getElementById("selection")
        let option = document.createElement("option");
        option.value = date;
        option.innerText = date;
        select.appendChild(option);
    }

    function playfile(file){
        if(!firstplay){
            let all = document.getElementsByClassName('button');
            for(let i in all){
               all[i].disabled = false;
            }
            firstplay = true;
        }
        playing = true;
        playbtn.innerText = "Pause";

        windowManager.sharedData.set("play", file.file);
    }

    function thumb(file){
        let viewbox = document.getElementById("viewbox");
        let thumb = document.createElement("div");
        thumb.className = "thumb";
        let thumbimg = document.createElement("img");
        thumbimg.src = thumbdir + file.file + ".png"
        thumbimg.alt = file.ISO;
        thumbimg.className = "thumbimg";
        let label = document.createElement("div");
        let date = new Date(file.ISO);
        if(file.mess === ""){
            label.innerText = date.toString();
        }
        else{
            label.innerText = file.mess;
        }

        thumb.appendChild(thumbimg);
        thumb.appendChild(label);
        thumb.onclick = (event) => {
            event.preventDefault();
            playfile(file)
            console.log(file.file);
        }
        viewbox.appendChild(thumb);
    }




    function startRecording() {
        windowManager.sharedData.set("record", true);
        document.getElementById("mess").innerText = "Recording... Press ~ to end recording (name your clips before ending recording!)";
        vidstream = document.getElementById("video");

        canvas.width = parseInt(canvas.style.width);
        canvas.height = parseInt(canvas.style.height);
        canvash.width = parseInt(canvash.style.width);
        canvash.height = parseInt(canvash.style.height);
        console.log("recording started!");

        function errorCallback(e) {
            console.log('Error', e)
        }

        // https://ucalgary.zoom.us/j/92278390769?pwd=LzREcGZJaGxJSmFOVWNhdnpidU9lUT09
        window.navigator.getUserMedia( {
                audio: false,
                video: {
                    mandatory: {
                        // width: { min: 1024, ideal: 1280, max: 1920 },
                        // height: { min: 576, ideal: 720, max: 1080 },
                        // chromeMediaSourceId: 'e0dba54a7062f30afbe7a3f906e2a69b4eff636357031793248e1547197dd3b7',
                        //     chromeMediaSourceId: '0f8ca0c80f220df342a4246f405196dcd8a5174d4821a1b6de87b98b0eb41f43',
                        // chromeMediaSourceId: 'a9a5941dca194c65010c55af6890de13d367371d675be7d62a6a03af7f555e42',
                        // chromeMediaSourceId: '69a54c6d837ebced4288488713136ac5db3badbde5d838ff51779f5ec47cd2c1',
                        // chromeMediaSourceId: 'f2d6de4fbc5cfababd8a286e8db71e6cddacce9dcc654ab890236e6a579cc88e',
                    chromeMediaSourceId: 'c60b4a1581d1b280b4bf56d5117562c1681eb621fe5af090ee982779000cf5a0',

                    
                    },
                    // width: { ideal: 4096 },
                    // height: { ideal: 2160 }
                }},
            (localMediaStream) => {
                filename = Date.now();
                handleStream(localMediaStream);

            }, errorCallback)

        // setTimeout(function() {
        //     stopRecording();
        //     if(looprecording){
        //         startRecording();
        //     }
        // }, recordingtime);
    }

    function handleStream(stream) {
        const track = stream.getVideoTracks()[0];
        camera = new ImageCapture(track);
        recorder = new MediaRecorder(stream);
        blobs = [];
        recorder.ondataavailable = function(event) {
            blobs.push(event.data);
        };
        recorder.start();
        if ("srcObject" in vidstream) {
            vidstream.srcObject = stream;
        } else {
            vidstream.src = window.URL.createObjectURL(stream);
        }
        if(first){
            requestAnimationFrame(tick);
            first = false;
        }


    }

    function handleUserMediaError(e) {
        console.error('handleUserMediaError', e);
    }

    function toArrayBuffer(blob, cb) {
        let fileReader = new FileReader();
        fileReader.onload = function() {
            let arrayBuffer = this.result;
            cb(arrayBuffer);
        };
        fileReader.readAsArrayBuffer(blob);
    }

    function toBuffer(ab) {
        return Buffer.from(ab);
    }

    function takephoto(context, filename){

        context.drawImage(video, 0, 0, canvash.width, canvash.height);
        var data = canvash.toBlob(function (blob) {
            toArrayBuffer(blob, function (ab){
                console.log(ab);
                var buffer = toBuffer(ab);

                var file = thumbdir + filename + ".png";
                fs.writeFile(file, buffer, function(err) {
                    if (err) {
                        console.error('Failed to save video ' + err);
                    }
                });
            })
        });
    //     ('image/jpg');
    //     var dsplit = data.split(',')
    //     var byteString = atob(dsplit[1]);
    //     var mimeString = dsplit[0].split(':')[1].split(';')[0];
    //     var ab = new ArrayBuffer(byteString.length);
    //     var buffer = toBuffer(ab);
    //     var file = thumbdir + filename + ".png"
    //     fs.writeFile(file, buffer, function(err) {
    //         if (err) {
    //             console.error('Failed to save video ' + err);
    //         }
    //     });
    }

    function stopRecording() {
        var filename = uuidv4();
        let anno = document.getElementById("anno");
        let annomess = anno.value;
        anno.value = "";

        // if(camera !== null){
        //     // console.log(camera);
        //
        //     camera.takePhoto().then((blob) => {
        //         // FileSaver.saveAs(blob, "./image.jpg");
        //         toArrayBuffer(blob, function (ab){
        //             console.log(ab);
        //             var buffer = toBuffer(ab);
        //
        //             var file = thumbdir + filename + ".jpg"
        //             fs.writeFile(file, buffer, function(err) {
        //                 if (err) {
        //                     console.error('Failed to save video ' + err);
        //                 }
        //             });
        //         })
        //         // var src = URL.createObjectURL(blob)
        //         // var x = document.createElement("a")
        //         // x.href = src
        //         // x.download = 'screenshot.jpg';
        //         // document.body.appendChild(x);
        //         // x.click();
        //     })
        //
        //
        // }

        takephoto(contexth, filename);
        document.getElementById("mess").innerText = "Processing Recording... This could take a moment)";
        processing = true;
        var save = function() {
            console.log(blobs);
            var data = new Blob(blobs, {type: 'video/webm'});
            var stream = data.stream();
            var file = videodir + filename + ".webm";

            toArrayBuffer(new Blob(blobs, {type: 'video/webm'}), function(ab) {
                console.log(ab);
                var buffer = toBuffer(ab);

                fs.writeFile(file, buffer, function(err) {
                    if (err) {
                        console.error('Failed to save video ' + err);
                    } else {
                        console.log('Saved video: ' + file);
                        windowManager.sharedData.set("process", true);
                        ffmpeg(file)
                            .videoCodec('libx264')
                            .audioCodec('libmp3lame')
                            .on('error', function(err) {
                                console.log('An error occurred: ' + err.message);
                            })
                            .on('end', function() {
                                fs.unlink(file, (err) => {
                                    if (err) {
                                        console.error(err)
                                    }
                                })
                                let today = new Date();
                                let date = today.getDate() + ""
                                let month = today.getMonth() + "";
                                let datestring = date + "/" + month;
                                let f = {
                                    file: filename,
                                    ISO: today.toISOString(),
                                    date: datestring,
                                    mess: annomess
                                }
                                videos.files.push(f);
                                if(!(videos.dates.includes(datestring))){
                                    videos.dates.push(datestring);
                                    createoption(datestring);
                                }
                                if(datestring === select.value){
                                    thumb(f)
                                }
                                windowManager.sharedData.set("videos", videos);
                                console.log('Processing finished !');
                                document.getElementById("mess").innerText = "Processing Done! Press ~ to record again";
                                processing = false;
                                playfile(f);
                            })
                            .save(videodir + filename +'.mp4');
                    }
                });
            });






        };
        recorder.onstop = save;
        recorder.stop();
    }

    function snapshot (context){
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        // imageData = context.getImageData(0, 0, canvas.width, canvas.height);
    }

    function tick(){
        requestAnimationFrame(tick);
        if (video.readyState === video.HAVE_ENOUGH_DATA){
            snapshot(context);
        }

    }

    document.addEventListener('keypress', (event) => {
        var name = event.key;
        var code = event.code;

        // Alert the key name and key code on keydown
        if(code === "Backquote"){

            event.preventDefault();
            if(!processing){
                if(!recording){
                    recording = !recording;
                    startRecording();
                }
                else{
                    recording = !recording;
                    stopRecording();
                }
            }


            // document.getElementById("marked").style.opacity = "0.5";
            // window.setTimeout(function(){
            //     document.getElementById("marked").style.opacity = "0";
            // }, 500)
        }
        if(code === "ArrowLeft"){
            event.preventDefault();
            windowManager.sharedData.set("back", true);
        }
        if(code === "ArrowRight"){
            event.preventDefault();
            windowManager.sharedData.set("forward", true);
        }
    });





    // var vid = document.getElementById("vid");
    //
    // function handtime(time){
    //     console.log(time);
    // }
    //
    // vid.addEventListener("timeupdate", (e) => {
    //     handtime(vid.currentTime*1000);
    // });
    // window.addEventListener('DOMContentLoaded', () => {
    //     vid.play();
    // });



    // const electron = require('electron');
    // // var remote = require('remote');
    // const remote = require('electron').remote;
    // const windowManager = remote.require('electron-window-manager');
    // // var windowManager = require("electron-window-manager");
    // const { v4: uuidv4 } = require('uuid');
    // // const remote = require('remote');
</script>
</body>
</html>